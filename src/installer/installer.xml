<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2005 - 2008  Eric Van Dewoestine

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!--
  - Installer build file that is executed upon installation.
  -->
<project name="eclim_installer" default="installer"
    xmlns:formic="antlib:org.formic.ant"
    xmlns:eclim="antlib:org.eclim.installer.ant">

  <property file="build.properties"/>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
  <taskdef name="for" classname="net.sf.antcontrib.logic.ForTask"/>

  <!--
    - Standard target to install the app.
    - Note: Must be named "installer".
    -->
  <target name="installer">
    <formic:installer property="install.complete"
        resources="resources.install" steps="resources.steps">
      <formic:path name="main">
        <formic:step name="welcome"/>
        <formic:step name="license"/>
        <formic:step name="eclipse"/>
        <formic:step name="vim"/>
        <formic:step name="requirements">
          <property name="provider"
              value="org.eclim.installer.step.RequirementProvider"/>
        </formic:step>
        <formic:step name="featureList">
          <property name="provider"
              value="org.eclim.installer.step.FeatureProvider"/>
        </formic:step>
        <formic:step name="summary"/>
        <formic:branch path="branch_eclipse_plugins">
          <or>
            <!-- seperate plugins dest may need to be added as a new site -->
            <and>
              <not> <os family="windows"/> </not>
              <not>
                <formic:contains string="eclipse.plugins" substring="eclipse.home"/>
              </not>
            </and>
            <!--istrue value="featureList.pydev"/-->
            <formic:istrue value="featureList.wst"/>
          </or>
        </formic:branch>
        <!--formic:branch path="branch_python_interpreter">
          <and>
            <istrue value="featureList.pydev"/>
            <not><isset property="pydev.skipped"/></not>
          </and>
        </formic:branch-->
        <formic:step name="install"/>
        <formic:step name="finished"/>
      </formic:path>

      <formic:path name="branch_eclipse_plugins">
        <formic:step name="eclipsePlugins"/>
      </formic:path>

      <formic:path name="branch_python_interpreter">
        <formic:step name="pythonInterpreter"/>
      </formic:path>
    </formic:installer>
  </target>

  <!--
    - Task that will run at the end of the wizard process to perform user
    - defined task after gathering info from the user via the wizard.
    - Note: Must be named "install".
    -->
  <target name="install">
    <property name="eclipse.plugins" value="${eclipse.home}/plugins"/>
    <property name="eclim.home"
        value="${eclipse.plugins}/org.eclim_${eclim.version}"/>

    <!-- shutdown any running instance of eclimd -->
    <eclim:shutdown/>

    <!-- remove old files -->
    <antcall target="clean"/>

    <!-- generate excludes file based on components user chose not to install -->
    <touch file="install.excludes"/>
    <eclim:installexcludes destfile="install.excludes"/>

    <!-- install eclipse plugins -->
    <if>
      <os family="windows"/>
      <then>
        <unzip src="org.eclim_${eclim.version}.zip"
            dest="${eclipse.plugins}">
          <patternset includes="**/*" excludesfile="${basedir}/install.excludes"/>
        </unzip>
        <replace dir="${eclipse.plugins}/org.eclim_${eclim.version}/bin"
            token="$${vim.files}" value="${vim.files}">
          <include name="eclim"/>
          <include name="eclim.*"/>
        </replace>
      </then>
      <else>
        <untar src="${basedir}/org.eclim_${eclim.version}.tar.gz"
            dest="${eclipse.plugins}" compression="gzip">
          <patternset includes="**/*" excludesfile="${basedir}/install.excludes"/>
        </untar>
        <replace file="${eclipse.plugins}/org.eclim_${eclim.version}/bin/eclim"
            token="$${vim.files}" value="${vim.files}"/>
        <replace file="${eclipse.plugins}/org.eclim_${eclim.version}/bin/native/linux/eclimd.desktop"
            token="$${eclim.home}" value="${eclipse.plugins}/org.eclim_${eclim.version}"/>
        <replace file="${eclipse.plugins}/org.eclim_${eclim.version}/bin/native/linux/eclimd"
            token="$${eclim.home}" value="${eclipse.plugins}/org.eclim_${eclim.version}"/>

        <!--
          - hard code the eclipse home for people that install plugins outside
          - of the ecilpse home.
          -->
        <if>
          <not>
            <contains string="${eclipse.plugins}" substring="${eclipse.home}"/>
          </not>
          <then>
            <replace file="${eclipse.plugins}/org.eclim_${eclim.version}/bin/eclimd"
                token="#$${eclipse.home}"
                value="ECLIM_ECLIPSE_HOME=&quot;${eclipse.home}&quot;"/>
          </then>
        </if>

        <chmod perm="755">
          <fileset dir="${eclipse.plugins}/org.eclim_${eclim.version}/bin">
            <include name="eclim"/>
            <include name="eclimd"/>
            <include name="native/**/*"/>
          </fileset>
        </chmod>

        <exec executable="make" failonerror="true"
            dir="${eclim.home}/src/nailgun"/>
        <move file="${eclim.home}/src/nailgun/ng" todir="${eclim.home}/bin"/>
      </else>
    </if>

    <!-- install vim plugins -->
    <unjar src="eclim_vim_${eclim.version}.jar" dest="${vim.files}">
      <patternset includes="**/*" excludesfile="${basedir}/install.excludes"/>
    </unjar>
    <replace file="${vim.files}/eclim/autoload/eclim.vim"
        token="&quot;$${vim.eclim.home}&quot;"
        value="let g:EclimHome = '${eclim.home}'"/>

    <antcall target="cleanup"/>
  </target>

  <!--
    - Task to remove old eclim files.
    -->
  <target name="clean">
    <!-- remove eclipse plugins -->
    <path id="eclim.plugins">
      <dirset dir="${eclipse.plugins}" includes="org.eclim*"/>
    </path>
    <property name="eclim.plugins" refid="eclim.plugins"/>
    <for list="${eclim.plugins}" param="eclim.plugin"
        delimiter="${path.separator}">
      <sequential>
        <delete dir="@{eclim.plugin}"/>
      </sequential>
    </for>

    <!-- remove vim files -->
    <delete failonerror="false">
      <fileset dir="${vim.files}/eclim">
        <include name="**/*"/>
        <exclude name="after/**/*"/>
        <exclude name="resources/**/*"/>
      </fileset>
    </delete>
  </target>

  <!--
    - Task that will run if the wizard was canceled, where any necessary
    - cleanup can occur.
    - Note: Must be named "canceled".
    -->
  <target name="canceled">
    <echo>Installation canceled.</echo>
    <antcall target="cleanup"/>
  </target>

  <!--
    - Cleanup any installer files when installer has completed or has been canceled.
    -->
  <target name="cleanup">
    <delete dir="${eclipse.plugins}/org.eclim.installer_${eclim.version}"/>
  </target>

</project>
