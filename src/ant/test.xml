<?xml version="1.0" encoding="UTF-8"?>
<!--
 Author: Eric Van Dewoestine
-->
<project name="test" default="test" basedir="../..">

  <!--
    - Task for starting eclimd and running unit tests.
    -->
  <target name="test" depends="build"
      description="Starts the eclim server and runs the junit tests">
    <if>
      <socket server="localhost" port="9091"/>
      <then>
        <runtarget target="tests.run"/>
      </then>
      <else>
        <echo>Starting eclimd...</echo>
        <parallel>
          <exec executable="${eclim.home}/bin/eclimd"
              output="build/test/eclimd.log"/>
          <sequential>
            <waitfor maxwait="20" maxwaitunit="second">
              <socket server="localhost" port="9091"/>
            </waitfor>
            <runtarget target="tests.run"/>
            <exec executable="${eclim.home}/bin/eclim">
              <arg line="-command shutdown"/>
            </exec>
          </sequential>
        </parallel>
      </else>
    </if>
  </target>

  <!--
    - Runs the tests after eclimd has been started.
    -->
  <target name="tests.run" description="Runs the junit tests">
    <mkdir dir="build/test/classes"/>
    <mkdir dir="build/test/results"/>

    <javac destdir="build/test/classes" debug="on" optimize="false"
        target="${test.javac.target}" source="${test.javac.target}"
        deprecation="${deprecation}">
      <src path="src/test/junit"/>
      <include name="**/*.java"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement path="build/classes"/>
      </classpath>
    </javac>

    <copy todir="build/test/classes" includeEmptyDirs="false">
      <fileset dir="src/test/junit">
        <include name="**/*"/>
        <exclude name="**/*.java"/>
      </fileset>
    </copy>

    <antcall target="test.setup_projects"/>

    <taskdef name="junit" classpathref="classpath"
        classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"/>

    <property name="junit.include" value="**/*Test"/>
    <junit printsummary="yes">
      <classpath>
        <path refid="classpath"/>
        <pathelement path="build/classes"/>
        <pathelement path="build/test/classes"/>
      </classpath>
      <formatter type="xml"/>
      <batchtest fork="yes" todir="build/test/results">
        <fileset dir="build/test/classes" includes="${junit.include}.class"/>
      </batchtest>
      <sysproperty key="eclim.home" value="${eclim.home}"/>
      <sysproperty key="eclim.version" value="${eclim.version}"/>
    </junit>

    <antcall target="test.teardown_projects"/>
  </target>

  <!--
    - Sets up the test projects.
    -->
  <target name="test.setup_projects">
    <delete includeEmptyDirs="true">
      <fileset dir="${eclipse.workspace}" includes="eclim_unit_test*/**/*"/>
      <fileset dir="${eclipse.workspace}" includes="eclim_unit_test*"/>
    </delete>
    <copy todir="${eclipse.workspace}">
      <fileset dir="src/test/resources" includes="eclim_unit_test*/**/*"/>
    </copy>

    <exec executable="${eclim.home}/bin/eclim" failonerror="true"
        output="build/test/eclim.log" append="false">
      <arg line="-command project_create -f ${eclipse.workspace}/eclim_unit_test_java"/>
    </exec>
  </target>

  <!--
    - Tears down the test projects.
    -->
  <target name="test.teardown_projects">
    <exec executable="${eclim.home}/bin/eclim" failonerror="true"
        output="build/test/eclim.log" append="true">
      <arg line="-command project_delete -n eclim_unit_test_java"/>
    </exec>

    <!--delete includeEmptyDirs="true">
      <fileset dir="${eclipse.workspace}" includes="eclim_unit_test*/**/*"/>
      <fileset dir="${eclipse.workspace}" includes="eclim_unit_test*"/>
    </delete-->
  </target>

</project>
