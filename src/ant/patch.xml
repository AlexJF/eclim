<?xml version="1.0" encoding="UTF-8"?>
<!--
  Author: Eric Van Dewoestine
-->
<project name="patch" default="patch" basedir="../..">

  <target name="patch.validate" unless="plugin">
    <fail message="Usage: ant -Dplugin=&lt;plugin-name&gt; patch"/>
  </target>

  <target name="patch.revert.validate" unless="plugin">
    <fail message="Usage: ant -Dplugin=&lt;plugin-name&gt; patch.revert"/>
  </target>

  <!--
    - Target to patch an eclipse plugin jar.
    -->
  <target name="patch" depends="patch.validate" if="plugin">
    <antcallback target="plugin.jar.resolve" return="plugin_jar"/>
    <echo>Patching plugin: ${plugin_jar}</echo>

    <!-- backup plugin file if necessary -->
    <if>
      <not><available file="${plugin_jar}.bak"/></not>
      <then>
        <copy file="${plugin_jar}" tofile="${plugin_jar}.bak"/>
      </then>
    </if>

    <mkdir dir="build/patch/${plugin}/classes"/>
    <javac destdir="build/patch/${plugin}/classes"
        debug="on" optimize="false"
        target="${javac.target}" source="${javac.target}"
        deprecation="${deprecation}">
      <src path="src/patch/${plugin}"/>
      <include name="**/*.java"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement path="build/classes"/>
      </classpath>
    </javac>

    <jar jarfile="${plugin_jar}" update="true">
      <fileset dir="build/patch/${plugin}/classes">
        <include name="**/*.class"/>
      </fileset>
    </jar>
  </target>

  <!--
    - Task to run patch for all plugin patches available.
    -->
  <target name="patch.all">
    <antcallback target="plugin.names.resolve" return="plugin_names"/>
    <foreach list="${plugin_names}" delimiter=":"
        target="patch" param="plugin"/>
  </target>

  <!--
    - Target to revert a patched jar to its original version.
    -->
  <target name="patch.revert">
    <antcallback target="plugin.jar.resolve" return="plugin_jar"/>
    <echo>Reverting patch for plugin: ${plugin_jar}</echo>
    <if>
      <available file="${plugin_jar}.bak"/>
      <then>
        <move file="${plugin_jar}.bak" tofile="${plugin_jar}"/>
      </then>
    </if>
    <delete dir="build/patch/${plugin}/classes"/>
  </target>

  <!--
    - Task to run patch for all plugin patches available.
    -->
  <target name="patch.revert.all">
    <antcallback target="plugin.names.resolve" return="plugin_names"/>
    <foreach list="${plugin_names}" delimiter=":"
        target="patch.revert" param="plugin"/>
  </target>

  <!--
    - Target which resolves the location of the plugin jar file.
    -->
  <target name="plugin.jar.resolve">
    <path id="plugin_jar">
      <fileset dir="${eclipse.home}/plugins/" includes="${plugin}_*.jar"/>
    </path>
    <property name="plugin_jar" refid="plugin_jar"/>
    <if>
      <or>
        <equals arg1="" arg2="${plugin_jar}"/>
        <not><available file="${plugin_jar}"/></not>
      </or>
      <then>
        <fail>
          No plugin jar file found for '${plugin}' in '${eclipse.home}/plugins'.
        </fail>
      </then>
    </if>
  </target>

  <!--
    - Target which resolves all plugin patch names.
    -->
  <target name="plugin.names.resolve">
    <path id="plugin_names">
      <dirset dir="src/patch" includes="*"/>
    </path>
    <property name="plugin_names" refid="plugin_names"/>
    <if>
      <equals arg1="" arg2="${plugin_names}"/>
      <then>
        <fail>No plugin patch directories found.</fail>
      </then>
    </if>
    <propertyregex property="plugin_names" override="true"
        input="${plugin_names}" regexp=".*?/([a-zA-Z0-9.]*(:|$))" replace="\1"/>
  </target>

</project>
