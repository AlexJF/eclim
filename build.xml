<?xml version="1.0" encoding="UTF-8"?>
<!--
 Author: Eric Van Dewoestine
-->
<project name="build" default="build" basedir=".">

  <property environment="env"/>
  <property file="src/ant/build.properties"/>
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <!-- classpath -->
  <path id="classpath">
    <fileset dir="lib" includes="**/*.jar"/>
    <!--fileset dir="build/dist" includes="**/*.jar"/-->
    <fileset dir="${eclipse.home}" includes="startup.jar"/>
    <fileset dir="${eclipse.home}/plugins" includes="**/*.jar" excludes="org.eclim_*/*.jar"/>
  </path>

  <!--
    - Initialize the build.
    -->
  <target name="init">
    <mkdir dir="build/classes"/>
    <mkdir dir="build/dist"/>
  </target>

  <!--
    - Main target for building the library.
    -->
  <target name="build" depends="init"
      description="Compiles the src and builds the jar file.">

    <javac destdir="build/classes" debug="on" optimize="false"
        target="${javac.target}" source="${javac.target}">
      <src path="src/java"/>
      <include name="**/*.java"/>
      <classpath refid="classpath"/>
    </javac>

    <!-- build jar files -->
    <jar jarfile="build/dist/eclim.jar">
      <fileset dir="build/classes">
        <include name="**/*.class"/>
      </fileset>
      <fileset dir="src/java" excludesfile="src/ant/exclude.properties">
        <include name="**/*"/>
        <exclude name="**/package.html"/>
        <exclude name="**/*.java"/>
      </fileset>
    </jar>

    <!-- deploy eclipse plugin -->
    <copy todir="${eclipse.home}">
      <mapper type="regexp"
        from="^(.*)org\.eclim(.*)$" to="\1org.eclim_${eclim.version}\2"/>
      <fileset dir="src/eclipse"
        includes="**/*" excludesfile="src/ant/exclude.properties"/>
    </copy>

    <mkdir dir="${eclipse.home}/plugins/org.eclim_${eclim.version}/log"/>
    <touch file="${eclipse.home}/plugins/org.eclim_${eclim.version}/log/.keep"/>
    <copy todir="${eclipse.home}/plugins/org.eclim_${eclim.version}">
      <fileset dir="." includes="LICENSE"/>
      <fileset dir="." includes="NOTICE"/>
      <fileset dir="lib" includes="**/*" excludesfile="src/ant/exclude.properties"/>
      <fileset dir="build/dist" includes="**/*.jar"/>
      <fileset dir="." includes="src/nailgun/**/*"/>
    </copy>
    <copy todir="${eclipse.home}/plugins/org.eclim_${eclim.version}/bin">
      <fileset dir="src/shell"
        includes="**/*" excludesfile="src/ant/exclude.properties"/>
    </copy>
    <replace dir="${eclipse.home}/plugins/org.eclim_${eclim.version}"
      includes="bin/*,META-INF/MANIFEST.MF"
      token="$${eclim.version}" value="${eclim.version}"/>
    <chmod dir="${eclipse.home}/plugins/org.eclim_${eclim.version}/bin"
      includes="**/*" perm="ugo+x"/>

    <!-- deploy vim plugin -->
    <copy todir="${vim.files.home}">
      <fileset dir="src/vim"
        includes="**/*" excludesfile="src/ant/exclude.properties"/>
    </copy>
    <replace dir="${vim.files.home}"
      includes="**/*.vim" token="$${eclim.version}" value="${eclim.version}"/>

  </target>

  <!--
    - Delete any generated artifacts of the build.
    -->
  <target name="clean" description="Deletes the build directory.">
    <delete dir="build"/>
    <delete dir="dist"/>
  </target>

  <!--
    - Target for generating the javadocs.
    -->
  <target name="javadoc" description="Generates the javadocs from the src.">
    <ant antfile="src/ant/docs.xml" target="javadoc"/>
  </target>

  <!--
    - Generate all the docs.
    -->
  <target name="docs" description="Generates the documentation.">
    <ant antfile="src/ant/docs.xml"/>
  </target>

  <!--
    - Target for unit testing the code.
    -->
  <target name="test" description="Runs the junit tests">
    <ant antfile="src/ant/test.xml"/>
  </target>

  <!--
    - Target for creating distributable jars.
    -->
  <target name="dist" depends="build" description="Creates the distributable jars.">
    <mkdir dir="dist"/>

    <!-- eclipse plugin jar -->
    <zip destfile="dist/org.eclim_${eclim.version}.jar">
      <fileset dir="${eclipse.home}/plugins/" excludesfile="src/ant/exclude.properties">
        <include name="org.eclim_${eclim.version}/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/ng"/>
        <exclude name="org.eclim_${eclim.version}/log/eclim.log"/>
      </fileset>
    </zip>

    <!-- vim plugins jar -->
    <path id="vim.plugins">
      <fileset dir="src/vim"
        includes="**/*" excludesfile="src/ant/exclude.properties"/>
    </path>
    <property name="vim.plugins" refid="vim.plugins"/>
    <propertyregex property="vim.plugins" input="${vim.plugins}" override="true"
      regexp="[a-zA-Z0-9-/]*?/vim/" replace=""/>
    <propertyregex property="vim.plugins" input="${vim.plugins}" override="true"
      regexp=":" replace=","/>
    <zip destfile="dist/eclim_vim_${eclim.version}.jar">
      <fileset dir="${vim.files.home}" includes="${vim.plugins}"/>
    </zip>
  </target>

</project>
