<?xml version="1.0" encoding="UTF-8"?>
<!--
 Author: Eric Van Dewoestine
-->
<project name="build" default="build" basedir=".">

  <property environment="env"/>
  <property file="src/ant/build.properties"/>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="src/ant/lib/ant-contrib-1.0b1.jar"/>
    </classpath>
  </taskdef>

  <import file="src/ant/docs.xml"/>
  <import file="src/ant/test.xml"/>

  <!-- exclude vim swap files -->
  <defaultexcludes add="**/*.swp"/>

  <!-- classpath -->
  <path id="classpath">
    <fileset dir="lib" includes="**/*.jar"/>
    <!--fileset dir="build/dist" includes="**/*.jar"/-->
    <fileset dir="${eclipse.home}" includes="startup.jar"/>
    <fileset dir="${eclipse.home}/plugins"
        includes="**/*.jar" excludes="org.eclim*/*.jar"/>
  </path>

  <!--
    - Initialize the build.
    -->
  <target name="init">
    <mkdir dir="build/classes"/>
    <mkdir dir="build/dist"/>
  </target>

  <!--
    - Main target for building the library.
    -->
  <target name="build" depends="init"
      description="Compiles the src and builds the jar file.">

    <property name="deprecation" value="false"/>
    <javac destdir="build/classes" debug="on" optimize="false"
        target="${javac.target}" source="${javac.target}"
        deprecation="${deprecation}">
      <src path="src/java"/>
      <include name="**/*.java"/>
      <classpath refid="classpath"/>
    </javac>

    <!-- eclim jar file -->
    <jar jarfile="build/dist/eclim.jar">
      <fileset dir="build/classes">
        <include name="org/eclim/**/*.class"/>
        <include name="org/eclipse/**/*.class"/>
        <exclude name="org/eclim/misc/**/*.class"/>
        <exclude name="org/eclim/plugin/*/**/*.class"/>
      </fileset>
      <fileset dir="src/java">
        <include name="org/eclim/**/*"/>
        <include name="org/eclipse/**/*"/>
        <exclude name="org/eclim/misc/"/>
        <exclude name="org/eclim/misc/*/"/>
        <exclude name="org/eclim/misc/**/*.class"/>
        <exclude name="org/eclim/plugin/*/"/>
        <exclude name="org/eclim/plugin/*/**/*"/>
        <exclude name="**/package.html"/>
        <exclude name="**/*.java"/>
      </fileset>
    </jar>

    <!-- eclim misc jar file -->
    <jar jarfile="build/dist/eclim-misc.jar">
      <fileset dir="build/classes">
        <include name="org/eclim/misc/**/*.class"/>
      </fileset>
      <fileset dir="src/java">
        <include name="org/eclim/misc/*/**/*"/>
        <exclude name="**/package.html"/>
        <exclude name="**/*.java"/>
      </fileset>
    </jar>

    <!-- update nailgun jar file -->
    <copy tofile="build/dist/lib/nailgun-0.7.1.jar" file="lib/nailgun-0.7.1.jar"/>
    <jar jarfile="build/dist/lib/nailgun-0.7.1.jar" update="true">
      <fileset dir="build/classes">
        <include name="com/martiansoftware/nailgun/**/*.class"/>
      </fileset>
    </jar>

    <!-- determine what plugins exist (other than the core) -->
    <path id="plugin.dirs">
      <dirset dir="build/classes/org/eclim/plugin" includes="*"/>
    </path>
    <property name="plugins" refid="plugin.dirs"/>
    <propertyregex property="plugins" override="true"
        input="${plugins}" regexp=":" replace=","/>
    <propertyregex property="plugins" override="true"
        input="${plugins}" regexp="/*?[a-zA-Z0-9-]*?/" replace=""/>
    <foreach list="${plugins}" target="plugin"
        inheritAll="true" param="plugin.name" trim="true"/>

    <!-- deploy eclipse plugins -->
    <sync todir="${eclipse.home}/plugins/org.eclim_${eclim.version}">
      <fileset dir="." includes="LICENSE"/>
      <fileset dir="." includes="NOTICE"/>
      <fileset dir="." includes="log4j.xml"/>
      <fileset dir="." includes="lib/**/*"
          excludes="lib/ant*.jar,lib/junit*.jar,lib/testng*.jar"/>
      <fileset dir="build/dist" includes="eclim.jar,eclim-misc.jar,lib/*.jar"/>
      <fileset dir="." includes="src/nailgun/**/*"/>
    </sync>

    <copy todir="${eclipse.home}">
      <mapper type="regexp"
          from="^(.*)(org\.eclim.*?)([/\\].*)$" to="\1\2_${eclim.version}\3"/>
      <fileset dir="src/eclipse" includes="**/*"/>
    </copy>

    <mkdir dir="${eclipse.home}/plugins/org.eclim_${eclim.version}/log"/>
    <touch file="${eclipse.home}/plugins/org.eclim_${eclim.version}/log/.keep"/>
    <copy todir="${eclipse.home}/plugins/org.eclim_${eclim.version}/bin">
      <fileset dir="src/shell" includes="**/*"/>
    </copy>

    <!-- build list of jar files for main plugin's manifest. -->
    <path id="lib.jars">
      <fileset dir="lib" includes="*" excludes="ant*.jar,junit*.jar,testng*.jar"/>
    </path>
    <property name="lib.jars" refid="lib.jars"/>
    <propertyregex property="lib.jars" override="true"
        input="${lib.jars}" regexp=":" replace=","/>
    <propertyregex property="lib.jars" override="true"
        input="${lib.jars}" regexp="/.*?/lib/" replace="lib/"/>

    <replace dir="${eclipse.home}/plugins"
        includes="org.eclim*_${eclim.version}/bin/**/*,
                  org.eclim*_${eclim.version}/about.html,
                  org.eclim*_${eclim.version}/plugin.properties,
                  org.eclim*_${eclim.version}/META-INF/MANIFEST.MF">
      <replacefilter token="$${eclim.version}" value="${eclim.version}"/>
      <replacefilter token="$${eclim.lib.jars}" value="${lib.jars}"/>
    </replace>

    <!--
      - separates lib entries onto new lines since the single line length of
      - the classpath entry seems to be limited.
      -->
    <replace dir="${eclipse.home}/plugins"
        includes="org.eclim*_${eclim.version}/META-INF/MANIFEST.MF">
      <replacetoken>,lib</replacetoken>
      <replacevalue>,
  lib</replacevalue>
    </replace>
    <chmod dir="${eclipse.home}/plugins/org.eclim_${eclim.version}/bin"
      includes="**/*" excludes="*.sed" perm="ugo+x"/>

    <!-- deploy vim files -->
    <copy todir="${vim.files.home}">
      <fileset dir="src/vim" includes="**/*"/>
    </copy>

  </target>

  <!--
    - Create the jar file for a plugin
    -->
  <target name="plugin">
    <jar jarfile="build/dist/eclim.${plugin.name}.jar">
      <fileset dir="build/classes">
        <include name="**/plugin/${plugin.name}/**/*.class"/>
      </fileset>
      <fileset dir="src/java">
        <include name="**/plugin/${plugin.name}/**/*"/>
        <exclude name="**/package.html"/>
        <exclude name="**/*.java"/>
      </fileset>
    </jar>
    <sync todir="${eclipse.home}/plugins/org.eclim.${plugin.name}_${eclim.version}">
      <fileset dir="." includes="LICENSE"/>
      <fileset dir="." includes="NOTICE"/>
      <fileset dir="build/dist" includes="eclim.${plugin.name}.jar"/>
    </sync>
  </target>

  <!--
    - Delete any generated artifacts of the build.
    -->
  <target name="clean" description="Deletes the build directory.">
    <delete dir="build"/>
    <delete dir="dist"/>
  </target>

  <!--
    - Target for creating distributable jars.
    -->
  <target name="dist" depends="build,javadoc"
      description="Creates the distributable jars.">
    <mkdir dir="dist"/>

    <!-- docs archive -->
    <zip destfile="${eclipse.home}/plugins/org.eclim_${eclim.version}/doc.zip">
      <fileset dir="build/doc" includes="**/*"/>
    </zip>

    <!-- src archive -->
    <zip destfile="${eclipse.home}/plugins/org.eclim_${eclim.version}/src.zip">
      <fileset dir="src/java" includes="**/*"/>
    </zip>

    <!-- eclipse plugin archives -->
    <zip destfile="dist/org.eclim_${eclim.version}.zip">
      <fileset dir="${eclipse.home}/plugins/">
        <include name="org.eclim_${eclim.version}/**/*"/>
        <include name="org.eclim.*_${eclim.version}/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/native/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/ng"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclim"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclimd"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclim*.sed"/>
        <exclude name="org.eclim_${eclim.version}/log/eclim.log"/>
      </fileset>
    </zip>
    <tar destfile="dist/org.eclim_${eclim.version}.tar.gz" compression="gzip">
      <tarfileset dir="${eclipse.home}/plugins/">
        <include name="org.eclim_${eclim.version}/**/*"/>
        <include name="org.eclim.*_${eclim.version}/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/native/windows/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/ng"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclim"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclimd"/>
        <exclude name="org.eclim_${eclim.version}/bin/**/*.bat"/>
        <exclude name="org.eclim_${eclim.version}/bin/**/*.exe"/>
        <exclude name="org.eclim_${eclim.version}/log/eclim.log"/>
      </tarfileset>
      <tarfileset dir="${eclipse.home}/plugins/" mode="755">
        <include name="org.eclim_${eclim.version}/bin/eclim"/>
        <include name="org.eclim_${eclim.version}/bin/eclimd"/>
      </tarfileset>
    </tar>

    <!-- vim plugins jar -->
    <path id="vim.plugins">
      <fileset dir="src/vim" includes="**/*"/>
    </path>
    <property name="vim.plugins" refid="vim.plugins"/>
    <propertyregex property="vim.plugins" input="${vim.plugins}" override="true"
        regexp="[a-zA-Z0-9-/]*?/src/vim/" replace=""/>
    <propertyregex property="vim.plugins" input="${vim.plugins}" override="true"
        regexp=":" replace=","/>
    <zip destfile="dist/eclim_vim_${eclim.version}.jar">
      <fileset dir="${vim.files.home}" includes="${vim.plugins}"/>
    </zip>
  </target>

</project>
